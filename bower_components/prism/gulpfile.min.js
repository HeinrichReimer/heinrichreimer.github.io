var gulp=require("gulp"),rename=require("gulp-rename"),uglify=require("gulp-uglify"),header=require("gulp-header"),concat=require("gulp-concat"),replace=require("gulp-replace"),fs=require("fs"),paths={componentsFile:"components.js",components:["components/**/*.js","!components/**/*.min.js"],main:["components/prism-core.js","components/prism-markup.js","components/prism-css.js","components/prism-clike.js","components/prism-javascript.js","plugins/file-highlight/prism-file-highlight.js"],plugins:["plugins/**/*.js","!plugins/**/*.min.js"],showLanguagePlugin:"plugins/show-language/prism-show-language.js",autoloaderPlugin:"plugins/autoloader/prism-autoloader.js",changelog:"CHANGELOG.md"};gulp.task("components",function(){return gulp.src(paths.components).pipe(uglify()).pipe(rename({suffix:".min"})).pipe(gulp.dest("components"))});gulp.task("build",function(){return gulp.src(paths.main).pipe(header("\n/* **********************************************\n     Begin <%= file.relative %>\n********************************************** */\n\n")).pipe(concat("prism.js")).pipe(gulp.dest("./"))});gulp.task("plugins",["languages-plugins"],function(){return gulp.src(paths.plugins).pipe(uglify()).pipe(rename({suffix:".min"})).pipe(gulp.dest("plugins"))});gulp.task("watch",function(){gulp.watch(paths.components,["components","build"]);gulp.watch(paths.plugins,["plugins","build"])});gulp.task("languages-plugins",function(a){fs.readFile(paths.componentsFile,{encoding:"utf-8"},function(h,k){if(!h){k=k.replace(/^var\s+components\s*=\s*|;\s*$/g,"");try{k=JSON.parse(k);var o={};var s={};for(var c in k.languages){if(c!=="meta"){var q=k.languages[c].displayTitle||k.languages[c].title;var f=c.substring(0,1).toUpperCase()+c.substring(1);if(q!==f){o[c]=q}for(var b in k.languages[c].aliasTitles){o[b]=k.languages[c].aliasTitles[b]}if(k.languages[c].require){s[c]=k.languages[c].require}}}var d=JSON.stringify(o);var r=JSON.stringify(s);var j=[{plugin:paths.showLanguagePlugin,map:d},{plugin:paths.autoloaderPlugin,map:r}];var m=0;var g=j.length;var i=function(){m++;if(m===g){a&&a()}};j.forEach(function(e){var l=gulp.src(e.plugin).pipe(replace(/\/\*languages_placeholder\[\*\/[\s\S]*?\/\*\]\*\//,"/*languages_placeholder[*/"+e.map+"/*]*/")).pipe(gulp.dest(e.plugin.substring(0,e.plugin.lastIndexOf("/"))));l.on("error",i);l.on("end",i)})}catch(n){a(n)}}else{a(h)}})});gulp.task("changelog",function(a){return gulp.src(paths.changelog).pipe(replace(/#(\d+)(?![\d\]])/g,"[#$1](https://github.com/PrismJS/prism/issues/$1)")).pipe(replace(/\[[\da-f]+(?:, *[\da-f]+)*\]/g,function(b){return b.replace(/([\da-f]{7})[\da-f]*/g,"[`$1`](https://github.com/PrismJS/prism/commit/$1)")})).pipe(gulp.dest("."))});gulp.task("default",["components","plugins","build"]);